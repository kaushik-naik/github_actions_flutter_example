name: "Build"

on:
  pull_request:
    branches:
      - dev
      - main
  push:
    branches:
      - dev
      - main
  workflow_dispatch:
    inputs:
      flavor:
        description: 'Select build flavor'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - stage
          - prod

jobs:
  # Job 1: Build (no approval needed)
  build:
    name: Build APK
    runs-on: ubuntu-latest
    outputs:
      build-success: ${{ steps.build-status.outputs.success }}
      flavor: ${{ steps.set-flavor.outputs.flavor }}

    steps:
      #1 Checkout Repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      #2 Set Flavor
      - name: Set Build Flavor
        id: set-flavor
        run: |
          FLAVOR="${{ github.event.inputs.flavor || 'qa' }}"
          echo "flavor=$FLAVOR" >> $GITHUB_OUTPUT
          echo "Building for flavor: $FLAVOR"

      #3 Setup Flutter
      - name: Set Up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: 'stable'

      #4 Install Dependencies
      - name: Install Dependencies
        run: flutter pub get

      #5 Building APK
      - name: Build APK
        run: |
          FLAVOR="${{ github.event.inputs.flavor || 'qa' }}"
          case $FLAVOR in
          qa)
            echo "Building QA APK..."
            ;;
          stage)
            echo "Building Stage APK..."
            ;;
          prod)
            echo "Building Prod APK..."
            ;;
          *)
            echo "Building default APK..."
            ;;
          esac
          flutter build apk --release

      #6 Set Build Status
      - name: Set Build Status
        id: build-status
        run: |
          echo "success=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Build completed successfully!"

  # Job 2: Request Approval for Artifact Upload (with QA environment protection)
  request-upload-approval:
    name: Request Upload Approval
    runs-on: ubuntu-latest
    needs: build
    environment: QA  # This will trigger the protection rules you've set up
    if: ${{ needs.build.outputs.build-success == 'true' }}
    outputs:
      upload-approved: ${{ steps.approval.outputs.approved }}

    steps:
      - name: Request Upload Approval
        id: approval
        run: |
          echo "üîç Requesting approval to upload artifact for ${{ needs.build.outputs.flavor }} build..."
          echo "Build was successful, awaiting approval for artifact upload."
          echo "approved=true" >> $GITHUB_OUTPUT

  # Job 3: Upload Artifact (only if approved)
  upload-artifact:
    name: Upload Build Artifact
    runs-on: ubuntu-latest
    needs: [build, request-upload-approval]
    if: ${{ needs.request-upload-approval.outputs.upload-approved == 'true' && needs.build.outputs.build-success == 'true' }}

    steps:
      #1 Checkout Repository (needed to access build files)
      - name: Checkout Repository
        uses: actions/checkout@v3

      #2 Setup Flutter (needed to rebuild since artifacts don't persist between jobs)
      - name: Set Up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.8'
          channel: 'stable'

      #3 Install Dependencies
      - name: Install Dependencies
        run: flutter pub get

      #4 Rebuild APK (since build artifacts don't persist between jobs)
      - name: Rebuild APK for Upload
        run: |
          echo "Rebuilding APK for upload (approved)..."
          flutter build apk --release

      #5 Upload Artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Releases-${{ needs.build.outputs.flavor }}
          path: |
            build/app/outputs/flutter-apk/app-release.apk

      - name: Upload Success
        run: |
          echo "‚úÖ Artifact uploaded successfully for ${{ needs.build.outputs.flavor }} build!"

  # Job 4: Workflow Status Summary
  workflow-summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [build, request-upload-approval, upload-artifact]
    if: always()

    steps:
      - name: Workflow Status Summary
        run: |
          echo "## Workflow Summary"
          echo "Build Status: ${{ needs.build.result }}"
          echo "Upload Approval Status: ${{ needs.request-upload-approval.result }}"
          echo "Upload Status: ${{ needs.upload-artifact.result }}"
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "‚úÖ Build completed successfully"
          else
            echo "‚ùå Build failed"
          fi
          
          if [[ "${{ needs.request-upload-approval.result }}" == "success" ]]; then
            echo "‚úÖ Upload approval granted"
          elif [[ "${{ needs.request-upload-approval.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Upload approval skipped (build may have failed)"
          else
            echo "‚ùå Upload approval denied or timed out"
          fi
          
          if [[ "${{ needs.upload-artifact.result }}" == "success" ]]; then
            echo "‚úÖ Artifact uploaded successfully"
          elif [[ "${{ needs.upload-artifact.result }}" == "skipped" ]]; then
            echo "‚è≠Ô∏è Artifact upload skipped (approval may have been denied)"
          else
            echo "‚ùå Artifact upload failed"
          fi
          
          # Overall workflow success determination
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "üéâ Overall Workflow: SUCCESS (Build completed)"
            exit 0
          else
            echo "üí• Overall Workflow: FAILED"
            exit 1
          fi